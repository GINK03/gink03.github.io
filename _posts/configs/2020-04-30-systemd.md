---
layout: post
title: "systemd"
date: 2020-04-30
excerpt: "systemd"
tags: [systemd]
config: true
comments: false
---

# systemd
 - 一般的にプロセスをデーモナイズするときに便利なLinuxのサービスの一つ
 - `~/.config/systemd/user`以下に配置することでユーザ権限でサービスを作成する事ができる

---

## ユーザのbinが使えるsystemdの作成
 - 使用するbinのPATHを通す必要がある。  
 - `echo $PATH` した内容をPATHに追加することでユーザの環境変数で設定されているPythonを動作させることができる。

**ユーザ権限でユーザのbinを用いて特定のプロセスを動かしたいとき**

```
[Unit]
Description=AUTO BACKUP SERVICE
After=network.target
StartLimitIntervalSec=0
[Service]
Type=simple
Restart=always
RestartSec=5
User=gimpei
Environment=PATH=<追加したいPATHを網羅したもの>
ExecStart=/usr/bin/env python3 <any python script>

[Install]
WantedBy=multi-user.target
```

### 配置

```console
$ sudo cp hoge.service /etc/systemd/system
```

### スタート

```console
$ sudo systemctl start hoge.service
```

### 有効化

```console
$ systemctl enable hoge.service
```

### 状態の確認

```console
$ systemctl status hoge.service
```

### ログ
 - 非常にデバッグしづらいので、ログを見ながら状態を確認するのがよい  
 - stdout, stderr的な内容が出力される  
 - NOTE: systemdの種類によってはユーザ権限で動作することができ、 `-f` オプションでトレイリングになる(要順序確認)  

```console
$ journalctl -u hoge.service -f
```

---

## ユーザ権限のsystemdの作成

### systemdのパス
 - `~/.config/systemd/user`の下にserviceファイルを置くことになる
 - `systemctl --user start|stop|enable|disable <foo>`となる
 - podmanの自動生成serviceファイルが正しく動作する
 - `loginctl enable-linger $USER`するとユーザがログインしていなくても動作する

--- 

### 例; duckduns(dynamic dns)のIP更新を行う
 - duckdnsと呼ばれるdynamic dnsに自分のIPを5分ごとに通知する

```
[Unit]
Description=DUCKDNS SERVICE
After=network.target
StartLimitIntervalSec=0
[Service]
Type=simple
Restart=always
RestartSec=5
User=gimpei
ExecStart=sh -c "curl \"https://www.duckdns.org/update?domains=gimpeik&token=*********************&ip=&verbose=true\"; sleep 300"

[Install]
WantedBy=multi-user.target
```
