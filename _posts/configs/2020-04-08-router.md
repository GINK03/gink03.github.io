---
layout: post
title: "router"
date: 2020-04-08
excerpt: "router"
tags: [router]
config: true
comments: false
---


# router
 Linuxをrouterにする。  
 ここでは、Ubuntu Linux 20.04をもとに説明します  
 特に、pppoeの接続を他のマシンでも使えるという設定の例です

## netplanでIPの設定

`/etc/netplan/01-netcfg.yaml` などを編集して以下の設定を反映させる

```yaml
# This file describes the network interfaces available on your system
# For more information, see netplan(5).
network:
  version: 2
  renderer: networkd
  ethernets:
    enp4s0:
          dhcp4: no
          dhcp6: true
          addresses: [192.168.50.1/24, 192.168.40.12/24, 192.168.30.12/24, 192.168.20.12/24]
          routes:
                - to: 0.0.0.0/0
                  via: 192.168.40.1
                  metric: 100
                - to: 0.0.0.0/0
                  via: 192.168.30.1
                  metric: 120
          nameservers:
          		addresses: [1.1.1.1, "2606:4700:4700::1111","2606:4700:4700::1001",8.8.4.4,8.8.8.8]
    enx3495db2d875c:
          dhcp4: true
          dhcp6: true
```

## dhcpdを起動

```console
sudo apt install isc-dhcp-server -y
```
以上のパッケージを入れて、設定ファイルに以下のようなレンジを書き込む

 - 設定ファイル : `/etc/dhcp/dhcpd.conf`  

```
option domain-name-servers 8.8.8.8, 8.8.8.4;

option subnet-mask 255.255.255.0;
	option broadcast-address 192.168.50.255;
	subnet 192.168.50.0 netmask 255.255.255.0 {
	range 192.168.50.20 192.168.50.250;
	option routers 192.168.50.1;
}
```

## pppoeconfでauthを通す
例えば以下のように、ユーザ名やなんやらを通す

```console
$ pppoeconf enx3495db2d875c 
```

二度目以降は、以下のコマンドですぐ接続できる

```console
$ pon dsl-provider
```

注意点として、device指定がpppoeconfパッケージは壊れているので、手動で以下のファイルを下記のように設定し直す必要がある。  

```conf
# Minimalistic default options file for DSL/PPPoE connections

noipdefault
defaultroute
replacedefaultroute
hide-password
#lcp-echo-interval 30
#lcp-echo-failure 4
noauth
persist
#mtu 1492
#persist
#maxfail 0
#holdoff 20
plugin rp-pppoe.so enx3495db2d875c
usepeerdns enx3495db2d875c
user "zed842793@excite.co.jp"
```

## ipforwardingを有効化

`/etc/sysctl.conf` にipv4のforwardingは以下のように設定する

```conf
net.ipv4.ip_forward=1
```

システムに反映する
```console
$ sudo sysctl -p 
```

## eth device間のiptableを設定

IPをどういうルールで転送するか、の設定を覚えさせる必要がある。  
`DEV_IN` は intranet側、 `DEV_EX` はwan(internet)側である。  

```sh
#!/bin/bash
# /etc/rc.local
# Default policy to drop all incoming packets.
# iptables -P INPUT DROP
# iptables -P FORWARD DROP
export DEV_IN="enp4s0"
export DEV_EX="ppp0"
echo "DEV_IN ${DEV_IN}"
echo "DEV_EX ${DEV_EX}"
# Accept incoming packets from localhost and the LAN interface.
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -i $DEV_IN -j ACCEPT
# Accept incoming packets from the WAN if the router initiated the connection.
iptables -A INPUT -i $DEV_EX -m conntrack \
--ctstate ESTABLISHED,RELATED -j ACCEPT
# Forward LAN packets to the WAN.
iptables -A FORWARD -i $DEV_IN -o $DEV_EX -j ACCEPT
# Forward WAN packets to the LAN if the LAN initiated the connection.
iptables -A FORWARD -o $DEV_IN -i $DEV_EX -m conntrack \
--ctstate ESTABLISHED,RELATED -j ACCEPT
# NAT traffic going out the WAN interface.
iptables -t nat -A POSTROUTING -o $DEV_EX -j MASQUERADE
# rc.local needs to exit with 0
exit 0
```

