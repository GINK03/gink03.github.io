---
layout: post
title:  "gspread"
date:   2020-07-22
excerpt: "gspread"
project: false
config: true
tag:
 - gspread
 - spreadsheet
comments: false
---

# gspread

## 日付の表示を %Y-%m-%d に

```
[表示形式] -> [数字] -> [表示形式の詳細設定] -> [その他の日付や時刻の設定]
```

## csv fileのインポート

```
[ファイル] -> [インポート] -> [アップロード]
```


## colabをバックエンドに編集

**boot up**  
```python
import pandas as pd
import numpy as np

!pip install --upgrade gspread

from google.colab import auth
auth.authenticate_user()

import gspread
from oauth2client.client import GoogleCredentials

gc = gspread.authorize(GoogleCredentials.get_application_default())
```

**spreadsheetを読み出してpandas DataFrameへ**  

```python
wb = gc.open_by_url('https://docs.google.com/spreadsheets/d/1Y4Gi7QBAiQESKL_qtV71u8ToiGqu8IDwhlT--gKeDuo/edit#gid=1578443245')

a = pd.DataFrame(wb.worksheet('{SHEET_NAME}').get_all_values())
a.columns = a.iloc[0].tolist()
a = a[1:]
```
headerもデータとして受け取ってしまうので再マッピングする

**pandasの内容をspreadsheetへ**  

```python
wb.values_update("{SHEET_NAME}", 
                params={'valueInputOption': 'USER_ENTERED'}, 
                body={"values":  np.vstack([df.columns, df.values]).tolist()})
```

vstackする必要があるのはarrayしかgspreadが受け取れないため

## terminalをバックエンドに編集

認証の方法がcolabと異なる。  

GCPの登録が個人でも必要であり、登録の後、[APIとサービス] -> [認証情報] -> [認証情報を作成] -> [サービスアカウント] -> (わかりやすい名前を入力) して作成する。  

作成後、サービスアカウント名をクリックして詳細画面を表示して、[鍵を追加]から鍵を追加する  

その情報を `service_account.json` 等の名前で `~/.config/gspread/service_account.json` とパスを編集して保存する  

そうすると、あるアカウント（以下の例では `gspread@starry-lattice-256603.iam.gserviceaccount.com` )で保存できる。  

google spreadsheetsを開いて共同編集者 `gspread@starry-lattice-256603.iam.gserviceaccount.com` を追加すると編集できるようになる  

```console
import pandas as pd
import numpy as np
import gspread
from pathlib import Path
import pickle

gc = gspread.service_account(filename=Path("~/.config/gspread/service_account.json").expanduser())
df = pd.read_csv("./input/2020_07_29_02.csv.gz", compression="gzip")
df = df.sample(n=10000)
wb = gc.open_by_url("https://docs.google.com/spreadsheets/d/1v_mB6FVI8qr5V7mXLdlZpvjOyV-aakDHdyRjg_qieWw")
wb.values_update("a", 
                params={'valueInputOption': 'USER_ENTERED'}, 
                body={"values":  np.vstack([df.columns, df.values]).tolist()})

```
