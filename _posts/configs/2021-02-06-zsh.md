---
layout: post
title: "zsh"
date: 2021-02-06
excerpt: "zshのtips"
project: false
config: true
tag: ["zsh", "shell"]
comments: false
---

# zshのtips

## 必要に応じてbitbucketに`.zshrc`を更新して管理する
 - [link](https://bitbucket.org/nardtree/gimpei-dot-files/src/master/files/zshrc)


## 使い方と具体例

### デフォルトのshellをzshにする

```console
$ chsh -s $(which zsh)
```
 - rootユーザでこの変更を行うのはリスクである

### ヒアドキュメント形式でzshを動かす

```console
$ zsh -f
```

### インターネット上にあるzshスクリプトを読み込む
ダウンロード場所を指定しておき、存在しなれけば読み込む  

```shell
# gistによる機能拡張
function load_remote_zshrc() {
  # 1. .tmpが存在しなかったら作成
  # 2. .tmp/zshrcが存在しなかったらダウンロード
  if [ ! -d ~/.tmp ]; then
        echo "create local .tmp directry."
        mkdir ~/.tmp
  fi
  if [ ! -f ~/.tmp/zshrc ]; then
        echo "create local .tmp directry."
        curl -o ~/.tmp/zshrc https://gist.githubusercontent.com/GINK03/e96cf8fa45a5c97846d5b6cb362d5ce7/raw/zshrc
  fi
  source ~/.tmp/zshrc
}
load_remote_zshrc
```

### 関数を定義して呼び出す

```shell
# 定義
function <function-name>() {
} 

# 呼び出し
<function-name>
```

### if文

```shell
if [[ "$PARAM" = 'master' ]]; then
  echo "これはTrue"
else
  echo "これはFalse"
fi
```
 - 必ず、`[[`のあとにはspace一個、`]]`の前にspace一個が必要

#### ディレクトリがあるかどうかのチェック

```shell
if [ -d ~/.tmp ]; then
  echo "存在する"
else
  echo "存在しない"
fi
```

#### ファイルがあるかどうかのチェック

```shell
if [ -f ~/target_file ]; then
  echo "存在する"
else
  echo "存在しない"
fi
```

#### 特定のコマンドが存在するかのチェック
この例では`lsb_release`が存在するかの確認

```shell
if type "lsb_release" > /dev/null; then
  echo "存在する"
fi
```

### case文

例えばOSで処理を分けるとき
```shell
case `uname` in
  Darwin)
	echo "MacOSX"
  ;;
  Linux)
	echo "Linux"
esac
```

### プログラムの異常終了をキャッチする

```console
$ echo $?
1
```
 
### terminalにgitのbranchを表示する

`zsh`には`vcs_info`というモジュールが存在し、gitのbranchを取得できる  
`precmd関数`はコマンドを打つ前に自動で走るコマンドで、この中に記すことで、コマンド度に最新のbranch情報に更新できる

```shell
autoload -U colors && colors
autoload -Uz vcs_info
zstyle ':vcs_info:*' enable git svn
zstyle ':vcs_info:git*' formats "%b"
function precmd() {
  vcs_info
  PS1="%{$fg[cyan]%}%n@%m%{$reset_color%}:%1 %~ (${vcs_info_msg_0_})$ "
}
setopt prompt_subst
```

### terminalに`datetime`を表示する
`PS1`のフォーマットは以下のようになる

```shell
%D{ %Y-%m-%d %M:%H:%S}
```

### terminalを改行する

`PS1`に直接`\n`を書けないので、以下のように変数を作って代替する

```shell
NEWLINE=$'\n'
PS1="hogehoge ${NEWLINE} foobar"
```

### aliasの実体を確認する

```console
$ type -a n
n is an alias for nvim
...
```

### aliasを解除する

`sudo`, `ip`などをラップしていると不整合を起こすことがあるのでそのような場合に使える

```console
$ unalias sudo
```

### rootユーザになる

環境によって方法が異なる

```console
$ sudo su
```

または

```console
$ sudo -s
```

### トラブルシューティング

#### 環境変数を適切に設定しているのに、`ls`コマンド等で文字化けが起きるとき
何らかの影響で`locales`パッケージが不整合を起こしていることがあった  

以下のコマンドで`ja_JP.UTF-8`に設定し直すことで治った事があった  

```console
$ sudo dpkg-reconfigure locales
```

