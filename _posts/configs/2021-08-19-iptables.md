---
layout: post
title: "iptables"
date: 2021-08-19
excerpt: "iptablesコマンド"
tags: ["iptables"]
config: true
comments: false
---

# iptablesコマンド

## 概要
 - パケットの流れを制御するソフトウェア
 - NATを構築する
 - Firewallを設定する
 - ip6のiptablesは`ip6tables`

---

## 引数

基本は以下の構成になる
```console
$ iptables -t <table> -A <CHAIN> -i|-o|-j <TARGET>
```

 - `-t <table>`
   - tableを操作
 - `-A <CHAIN>`
   - CHAINにルールを追加
 - `-P|--policy <CHAIN> <TARGET>`
   - CHAINにTARGETを適応
 - `-N <CUSTOMCHAIN>`
   - CUSTOMCHAINという名前のCHAINを作成
 - `-F <CUSTOMCHAIN>`
   - CUSTOMCHAINからルールを削除
 - `-X <CUSTOMCHAIN>`
   - CUSTOMCHAINを削除
 - ルール関連
   - `-i`; inputインターフェース
   - `-o`; outputインターフェース
   - `-j <TARGET>`; ターゲット
   - `-p <proto>`; プロトコルの選択

 - `<table>`の種類
   - `nat`
	 - `<CHAIN>`
	   - `POSTROUTING`
	   - `PREROUTING`
	   - `OUTPUT`
   - `filter`
	 - `<CHAIN>`
	   - `INPUT`
	   - `OUTPUT`
	   - `FORWARD`

 - `<TARGET>`の種類
   - `ACCEPT`
   - `DROP`
   - `REJECT`; 拒否通知を返す
   - `LOG`; 通信を記録する
   - nat
	 - `MASQUERADE`
	 - `SNAT`; IPを指定できる


---

## interfaceでNATを構築する

```console
# iptables -A FORWARD -i wg0 -j ACCEPT
# iptables -t nat -A POSTROUTING -o enp1s0 -j MASQUERADE
# ip6tables -A FORWARD -i wg0 -j ACCEPT
# ip6tables -t nat -A POSTROUTING -o enp1s0 -j MASQUERADE
```
 - inputを`wg0`として、`enp1s0`をアウトプットにする

---

## forwardした内容の確認

```console
# iptables -L -v -n
```

---

## firewallを無効化する
 - debian限定(ubuntuは別途fwソフトが入っている)

```console
# iptables -I INPUT -j ACCEPT
# ip6tables -I INPUT -j ACCEPT
```

---

## iptablesで設定した内容を恒久化する(iptables-persistentを利用)

`iptables-persistent`をインストールするだけでよい  
iptablesの変更内容が保存され、再起動時に復元される  

```console
$ sudo apt install iptables-persistent
```

**手動で保存する場合**  

```console
$ dpkg-reconfigure iptables-persistent
```
で、対話式の保存画面が現れる

## iptablesの設定内容をバックアップと復元

**バックアップ**  
```console
# iptables-save > <backup-file>
```

**復元**  
```console
# iptables-restore < <backup-file>
```
