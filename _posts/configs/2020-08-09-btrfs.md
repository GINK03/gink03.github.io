---
layout: post
title:  "btrfs"
date:   2020-08-09
excerpt: "btrfs"
project: false
config: true
tag: []
comments: false
---

# btrfs
 - 現状、最もアドホックな分析やデータレークで安定するfilesystem
 - inodeが大量に必要なフォーマット等で安定性が高い
   - 5chのデータを扱うような場合

## install

**ubuntu, debian**  
```console
$ sudo apt install btrfs-progs
```

## 基本的な操作

### format filesystem 

```console
$ sudo mkfs -t btrfs -f /dev/<sdx>
```
 - `-f`; すでに他のファイルシステムでフォーマットされているときに必要

### repair format filesystem

```console
$ sudo btrfs check --repair --force /dev/<sdx>
```

 - これで治らない場合、ディスクが故障している可能性がある

### 空き容量の確認

```console
$ sudo btrfs filesystem show /dev/<sdx>
```
または
```console
$ btrfs filesystem df ./<mount-point>
```

### デフラグ

```console
$ sudo btrfs filesystem defragment -r -v <mount_dir>
```

### ext4ディスクをbtrfsに変換する

```console
$ sudo btrfs-convert /dev/<sdx>
create btrfs filesystem:
        blocksize: 4096
        nodesize:  16384
        features:  extref, skinny-metadata (default)
        checksum:  crc32c
free space report:
        total:     1000204886016
        free:      892787671040 (89.26%)
creating ext2 image file
...
```
 - ext2でスナップショットを作成する必要があるらしく時間がかかる(1TBのSSDで5~6時間程度)


## サブボリュームの使い方

### 概要
 - `btrfs`でフォーマットされたディスクに対してディレクトリを作るような操作でマウント可能なボリュームを切り出す機能

### 具体的な操作

**サブボリュームの作成**  
```console
$ sudo btrfs subvolume create <sv-name>
```

**サブボリュームのパラメータの確認**  
```console
$ sudo btrfs subvolume show <sv-name>
<sv-name>
        Name:                   <sv-name>
        UUID:                   7a5be655-2329-024a-a24a-9fa93bfde24c
        Parent UUID:            -
        Received UUID:          -
        Creation time:          2021-12-11 21:31:41 +0900
        Subvolume ID:           796
        Generation:             11310
        Gen at creation:        11302
        Parent ID:              5
        Top level ID:           5
        Flags:                  -
        Snapshot(s):
```

**サブボリュームを適当な場所にマウント**  
```console
$ sudo mount /dev/<サブボリュームを含むディスク> -o subvol=<sv-name> <target-mount-point>
```

## 参考
 - [How to Create and Mount Btrfs Subvolumes](https://linuxhint.com/create-mount-btrfs-subvolumes/)
 - [Btrfs](https://wiki.archlinux.jp/index.php/Btrfs)
