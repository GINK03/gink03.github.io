---
layout: post
title:  "ssh"
date:   2020-11-01
excerpt: "ssh"
project: false
config: true
tag: ["ssh", "sshd", "security"]
comments: false
---

# ssh

## ssh-keygenの使い方

```console
$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (<home path>/.ssh/id_rsa):
Enter passphrase (empty for no passphrase): # 入力するとパスワードが必須になるので面倒
Enter same passphrase again: # 入力するとパスワードが必須になるので面倒
Your identification has been saved in <home path>/.ssh/id_rsa
Your public key has been saved in <home path>/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:krbM0upueBPo3zNsXbYk7spNZGPNd/lBIPYzXhgaIQ0 <user name>@debian
The key's randomart image is:
+---[RSA 3072]----+
|         Eo=.o   |
|          o.= +  |
|           . = o |
|       . o  . =. |
|   .  + S o ..o. |
|  . .= *..+. . ..|
| . ..o=o.= .    .|
|  o +==oo .      |
|   *=o+=o        |
+----[SHA256]-----+
```

## 設定ファイルについて
 - `/etc/ssh/sshd_config`
   - sshのサーバ側の設定
 - `/etc/ssh/ssh_config`
   - sshのクライアント側の設定

## ユーザの認証情報
 - `$HOME/.ssh/authorized_keys`に公開鍵情報を書き込む

## `~/.ssh/known_hosts`について
 - クライアントからサーバへの接続先が偽造されたときに気付けるように情報が異なるようなことがあった場合、警告がでる

## 絶対やっておくべきセキュリティ対策  

**passwordログインの無効化**  
```console
$ echo "PasswordAuthentication no" | sudo tee -a /etc/ssh/sshd_config
```

**`ssh.service`の再起動**  
```console
$ sudo systemctl restart ssh.service
```
再起動しないとpasswordログインの無効化が反映されない

## 脆弱なユーザ名とパスワードは使用しない
例えば、ユーザ名`test`, パスワード`test`のような脆弱な組み合わせは用いてはならない。ssh経由でログインされて、仮想通貨のバイナリ等を送られてマイニングに利用されたりするからである。  


## `~/.ssh/config`の書き方

`~/.ssh/id_github`が秘密鍵のとき、以下のようにする  

githubとか公開鍵を登録しているときなど便利  

```config
Host github.com 
  User git
  Port 22
  HostName github.com
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host bitbucket.org
  User git
  Port 22
  HostName bitbucket.org
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host 192.168.*.*
  User gimpei
  StrictHostKeyChecking no
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host 2620:9b::*
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes
```

## `/etc/ssh/sshd_config`の項目
 - `PermitRootLogin <yes|no>`
   - default yes
 - `PasswordAuthentication <yes|no>`
   - default yes
 - `PermitEmptyPasswords <yes|no>`
   - default no
 - `PubkeyAuthentication <yes|no>`
   - sshのプロトコルv2で認証するか
 - `X11Forwarding <yes|no>`
   - default no
 - `AllowUsers <user1> <user2> ...`
   - 接続を許可するユーザ
 - `DenyUsers <user1> <user2> ...`
   - 接続を禁止するユーザ
 - `AllowGroups <group1> <group2> ...`
   - 接続を許可するグループ
 - `DenyGroups`
   - 接続を禁止するグループ

## 多くのファイルを転送する
 - [/transport_a_lot_files](/transport_a_lot_files)
