---
layout: post
title:  "ssh"
date:   2020-11-01
excerpt: "ssh"
project: false
config: true
tag: ["ssh", "sshd", "security"]
comments: false
---

# ssh

---

## ssh-keygenの使い方

### キーの作成

```console
$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (<home path>/.ssh/id_rsa):
Enter passphrase (empty for no passphrase): # 入力するとパスワードが必須になる
Enter same passphrase again: # 入力するとパスワードが必須になる
Your identification has been saved in <home path>/.ssh/id_rsa
Your public key has been saved in <home path>/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:krbM0upueBPo3zNsXbYk7spNZGPNd/lBIPYzXhgaIQ0 <user name>@debian
The key's randomart image is:
+---[RSA 3072]----+
|         Eo=.o   |
|          o.= +  |
|           . = o |
|       . o  . =. |
|   .  + S o ..o. |
|  . .= *..+. . ..|
| . ..o=o.= .    .|
|  o +==oo .      |
|   *=o+=o        |
+----[SHA256]-----+
```

### 秘密鍵から公開鍵を作成する

**pubフォーマットの場合**  
```console
$ ssh-keygen ssh-keygen -y -f <private-key-path> > <public-key-path>
```

**pemフォーマットの場合**  
```console
$ openssl rsa -in <private-key-path> -pubout > <public-key-path>
```

---

## 設定とセキュリティ

### 設定ファイルについて
 - `/etc/ssh/sshd_config`
   - sshのサーバ側の設定
 - `/etc/ssh/ssh_config`
   - sshのクライアント側の設定

### サーバサイドの公開鍵の配置場所について
 - `$HOME/.ssh/authorized_keys`に公開鍵情報を書き込む

### `~/.ssh/known_hosts`について
 - クライアントからサーバへの接続先が偽造されたときに気付けるように、フィンガープリント情報が異なるようなことがあった場合、警告がでる

### 絶対やっておくべきセキュリティ対策  
 - passwordログインを無効化
 - サービスの再起動

```console
#passwordログインの無効化
$ echo "PasswordAuthentication no" | sudo tee -a /etc/ssh/sshd_config
#ssh.serviceの再起動
$ sudo systemctl restart ssh.service
```

### `~/.ssh/config`の書き方
 - `~/.ssh/id_github`が秘密鍵のとき、以下のようにする  
 - githubとか公開鍵を登録しているときに便利  
 - 凡例
   - `User`: デフォルトでどのユーザでログインするか
   - `StrictHostKeyChecking`: 接続先のフィンガープリントが異なっているときに厳格にするかしないか
   - `IdentityFile`: 秘密鍵のpath
   - `IdentitiesOnly`: 秘密鍵が必要かどうか
   - `TCPKeepAlive`: 接続状態を継続したいかどうか

```config
Host github.com 
  User git
  Port 22
  HostName github.com
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host gist.github.com 
  User git
  Port 22
  HostName github.com
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host bitbucket.org
  User git
  Port 22
  HostName bitbucket.org
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host 192.168.*.*
  User gimpei
  StrictHostKeyChecking no
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes

Host 2620:9b::*
  IdentityFile ~/.ssh/id_github
  TCPKeepAlive yes
  IdentitiesOnly yes
```

### /etc/ssh/sshd_configの項目
 - `PermitRootLogin <yes|no>`
   - default yes
 - `PasswordAuthentication <yes|no>`
   - default yes
 - `PermitEmptyPasswords <yes|no>`
   - default no
 - `PubkeyAuthentication <yes|no>`
   - sshのプロトコルv2で認証するか
 - `X11Forwarding <yes|no>`
   - default no
 - `AllowUsers <user1> <user2> ...`
   - 接続を許可するユーザ
 - `DenyUsers <user1> <user2> ...`
   - 接続を禁止するユーザ
 - `AllowGroups <group1> <group2> ...`
   - 接続を許可するグループ
 - `DenyGroups`
   - 接続を禁止するグループ

---

## TIPS

### 多くのファイルを転送する
 - [/transport_a_lot_files](/transport_a_lot_files)

### 脆弱なユーザ名とパスワードは使用しない
 - 例えば、ユーザ名`test`, パスワード`test`のような脆弱な組み合わせは用いてはならない。ssh経由でログインされて、仮想通貨のバイナリ等を送られてマイニングに利用されたりするからである。  

---

## トラブルシューティング

### macosで突然sshできなくなる
 - 原因
   - sshのキー指定に対して自動で読み込む順序などがあるようで、OCIなどのクラウドの一時的なsshの秘密鍵と公開鍵を`.ssh`に置くと、configで設定したファイルが読み込まれなくなる
 - 対応
   - `.ssh/oci`のようなサブフォルダに分けて管理することで解決する
 - 参考
   - [Permission denied (publickey) - mac/serverfault](https://serverfault.com/questions/938870/permission-denied-publickey-mac)
