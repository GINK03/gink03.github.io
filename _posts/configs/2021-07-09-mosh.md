---
layout: post
title: "mosh"
date: 2021-07-09
excerpt: "moshについて"
tags: ["mosh"]
config: true
comments: false
sort_key: "2022-05-20"
update_dates: ["2022-05-20","2022-05-02","2022-01-08","2021-11-26","2021-08-14","2021-08-08","2021-07-09"]
---

# moshについて

## 概要
 - roamingとlocal echoを提供するソフトウェア
   - roamingとは通信経路の切り替えに対応する
   - local echoとは通信が安定しない環境などで結果を予測して表示する仕組み
 - sshのUDPラッパー
   - UDPのポートはレンジで60000-61000を使用する

## 24 bit color(true color)に対応させる
 - moshをパッケージからインストールするとtrue colorに対応しないことがある
   - vimの色等で繊細な表現ができないなどのデメリットがある
 - `github.com/mobile-shell/mosh`から直接ビルドすることで対応可能である

### ubuntuでbuildしてインストール

```console
$ sudo apt remove mosh # もしaptでインストールされていたら外す
$ sudo apt install protobuf-compiler
$ cd ~/.opt
$ git clone https://github.com/mobile-shell/mosh.git
$ cd mosh
$ sh ./autogen.sh
$ ./configure
$ make -j 8
$ sudo make install
```
 - 参考
   - [Compile and install mosh error on Linux](https://gist.github.com/kuntau/37698a5159ceac40982b1f7ae96b7db8)

### osxでbuildしてインストール

**protocolbufferのbuildとインストール**  
```console
$ cd ~/.opt
$ git clone https://github.com/protocolbuffers/protobuf
$ cd protobuf
$ ./autogen.sh
$ ./configure
$ make -j 8
$ sudo make install
```

**moshのbuildとインストール**  
```console
$ cd ~/.opt
$ git clone https://github.com/mobile-shell/mosh.git
$ cd mosh
$ ./autogen.sh
$ ./configure
$ make -j 8
$ sudo make install
```

## 使用法

**最小の構成コマンド**  

```console
$ mosh user@server 
```

**サーバの実行ファイルを指定する(osxをホストとするとき)**  

```console
$ mosh user@server --server=BIN_PATH
```

`BIN_PATH`は以下のケースが多い  

```console
$ mosh user@server --server=/usr/local/bin/mosh-server
```

**プライベートキーを指定して接続**  

```console
$ mosh --ssh="ssh -i KEY_PATH" user@server
```

## moshクライアントの終了について
 - サーバサイドに接続できなくなった時、moshクライアントは自動的に終了することはないので手動で終了する必要がある
 - `ctrl+^`でモードに入って`.(ピリオド)`で終了する事ができる

## predictオプションについて
 - 投機的なローカルエコーを制御するオプション
 - キーを打ってから戻りが遅い場合、とりあえず投機的な結果から画面に表示するなど、遅延を軽減する効果がある

**-aオプション**  
 - (moshが自信があれば)常に投機的に予測する

**-nオプション**  
 - 投機的なローカルエコーを使用しない

---

## トラブルシューティング

### osxに接続する際に、mosh-serverが見つからないと出る
 - 原因
   - sshdの標準PATHに`/usr/local/bin`が含まれていないことが原因
 - 対応
   - [/ssh/](/ssh/)の"sshした際のサーバサイドの環境変数について"を参照して、PATHを追加する
