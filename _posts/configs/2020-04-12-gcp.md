---
layout: post
title: "gcp"
date: 2020-04-12
excerpt: "gcp"
tags: [gcp]
config: true
comments: false
---

# gcp
 特に、GCPの特定の機能について紹介する　　


## preemtible

最大24時間でシャットダウンしてしまうインスタンスで、1/4 ~ 1/5で利用できる。  

例えば、以下のスクリプトは、 `hook.py` でsshfsで自宅のPCにログイン、マウントさせ、非常に重い処理を行わさている。  

結果は細かいファイル粒度でマウントしたディスクに書き込まれるので、切断されてしまっても問題ない。  

```python
import pandas as pd
import os
from subprocess import Popen, PIPE
import sys
import json
import shlex
import paramiko
from os import environ as E
import random
import time
from collections import namedtuple
from concurrent.futures import ProcessPoolExecutor
from concurrent.futures import ThreadPoolExecutor
import datetime


class Instance:
    def __init__(self, name, preemptible, status, natIP, zone):
        self.name = name
        self.preemptible = preemptible
        self.status = status
        self.natIP = natIP
        self.zone = zone

def run(arg):
    TIMEOUT = 60 * 60
    MAX_INSTANCES_NUM = 36
    PREV_PROC_KILL = 'pgrep python3 | xargs kill -9 2>&1 >/dev/null'
    print(arg, datetime.datetime.now())
    ret = os.popen("gcloud compute instances list --format json").read()
    ret = json.loads(ret)
    """
    最初に未起動のpreemptible instanceを全部起動する
    """
    for a in ret:
        zone = a.get('zone').split('/')[-1]
        name = a.get('name')
        preemptible = a.get('scheduling').get('preemptible')
        status = a.get('status')
        natIP = a.get('networkInterfaces')[0]['accessConfigs'][0].get('natIP')
        instance = Instance(name, preemptible, status, natIP, zone)
        if instance.preemptible and instance.status == "RUNNING":
            os.system(f'gcloud compute ssh {name} --zone={zone} --ssh-key-file=~/.ssh/id_github --command="{PREV_PROC_KILL}" ')
        if instance.preemptible and instance.status == "TERMINATED":
            ret = os.popen(f"gcloud compute instances start {name} --zone={zone} --format=json").read()
            time.sleep(10.0)
    """
	instance objectを回収
	"""
	ret = os.popen("gcloud compute instances list --format json").read()                                                                                                   
	ret = json.loads(ret)
    instances = []
    for a in ret:
        zone = a.get('zone').split('/')[-1]
        name = a.get('name')
        preemptible = a.get('scheduling').get('preemptible')
        status = a.get('status')
        natIP = a.get('networkInterfaces')[0]['accessConfigs'][0].get('natIP')
        instance = Instance(name, preemptible, status, natIP, zone)
        if instance.preemptible:
            instances.append(instance)
    """
	コマンドを実行
	"""
	def process_run(instance):
	  pipe = None
	  with Popen(['gcloud', 'compute', 'ssh', f'{instance.name}', f'--zone={instance.zone}', f'--ssh-key-file=~/.ssh/id_github', f'--command', 'python3 ./hook.py', ], stdout=pipe, stderr=pipe,) as proc:            
		try:
		  proc.wait(timeout=TIMEOUT)
		except Exception as exc:
		  proc.terminate()
		  print(f'exc = {exc}', file=sys.stderr)

    try:
        with ThreadPoolExecutor(max_workers=MAX_INSTANCES_NUM) as exe:
            exe.map(process_run, instances)
    except Exception as exc:
        print(f'exc = {exc}', file=sys.stderr)

if __name__ == "__main__":
  run(0)
```
