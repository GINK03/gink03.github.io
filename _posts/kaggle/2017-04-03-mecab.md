---
layout: post
title: "mecab設定"
date: 2017-04-02
excerpt: "mecabの設定について"
project: false
config: true
kaggle: true
tag: ["nlp", "mecab"]
comments: false
---

## インストール

**ubuntu**  
```console
$ sudo apt install mecab libmecab-dev mecab-ipadic
$ sudo apt install mecab-ipadic-utf8
$ sudo apt install python-mecab
```

**osx**  
```console
$ brew install mecab; brew install mecab-ipadic
```

### python3 binding
```console
$ python3 -m pip install mecab-python3
```

### neologdインストール
```console
$ git clone --depth 1 https://github.com/neologd/mecab-ipadic-neologd.git; cd mecab-ipadic-neologd; ./bin/install-mecab-ipadic-neologd -n
```

#### 任意の場所にインストール
 - 任意のpathに辞書をインストールできる

```console
$ ./bin/install-mecab-ipadic-neologd -n\
  --prefix $HOME/.lib/mecab-ipadic-neologd
```

### 新規に単語を追加する
 - 参考
   - [Add words to MeCab's user dictionary on Ubuntu for use in Python](https://linuxtut.com/en/d743a9d757dd3097a6f6/)

### mecabrcの設定(最近はpythonインスタンスの中で初期化するほうがメジャー)

```
# vim /etc/mecabrc
dicdir = /usr/lib/mecab/dic/mecab-ipadic-neologd
dicdir = /usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd/ # 17.04
```
 - 最近では設定ファイルのパスが`/usr/local/etc/mecabrc`に変更された

### 2020/05~, Python3で使うとき

**分かち書き**  

```python
# ubuntu linux
parser = MeCab.Tagger("-Owakati -d /usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd/") # /etc/mecabrcに設定されているに関わらず、明示的にpython3の内部で辞書ファイルのpath指定をする必要がある
# osx
parser = MeCab.Tagger("-Owakati -d /usr/local/lib/mecab/dic/mecab-ipadic-neologd/") 
assert parser.parse("COVID19").strip().split() == ["COVID19"], "辞書ファイルが古いです" # 辞書が反映されていないと落ちるはず
```

**品詞解析**  

**意味のある名詞のみを取り出す**  

```python
parser = MeCab.Tagger("-Ochasen -d /usr/local/lib/mecab/dic/mecab-ipadic-neologd/")

tf = {}
try:
    text = mojimoji.han_to_zen(text, kana=True, digit=False, ascii=False)
    for line in set(parser.parse(text).strip().split("\n")):
        entities = line.split("\t")
        if len(entities) <= 4:
            continue
        word = entities[0] # もとの単語
        yomi = entities[1] # 読み
        orig = entities[2] # 未活用の原型
        type = entities[3] # 品詞

        if "名詞" in type:
            if type in {"名詞-数", "名詞-代名詞", "名詞-非自立", "名詞-副詞可能", "接頭詞-名詞接続"}:
                continue
            tf[word] += 1
        if "記号" in type:
            continue
        if "形容詞" in type or "動詞" in type:
            tf[orig] += 1
except TypeError:
    pass
except Exception as exc:
    print(exc)
```

**基本的なサニタイズ(ノイズワード除去等)**  

```python
if "名詞" in type:
    if type in {"名詞-数", "名詞-代名詞", "名詞-非自立", "名詞-副詞可能", "接頭詞-名詞接続"}:
        continue
    if regex.match("^\p{Hiragana}{1,}$", orig):  # 1,2文字のひらがなは集計しない
        continue
    #if regex.match("^[a-zA-Z]{1,5}", word): # 1 ~ 5の英語はスキップ
    #    continue
    if regex.match("^\d{1,}[a-zA-Z]{1,}", word):
        continue
    if regex.match("^\d{1,}[^\d]{1,}", word):
        continue
    if regex.match("^[^\d]{1,}\d{1,}", word) and len(word) <= 2:
        continue
    if regex.match("^[a-zA-Z]{1,5}$", word):
        continue
    if regex.match("^[a-zA-Z]", word) and len(word) <= 2:
        continue
    if regex.match("^-", word):
        continue 
    if len(word) <= 1 and  not(eomoji_pattern.match(word) or  emoji_extra.match(word)):  # 1文字の表現はほとんどノイズなので集計しない
        continue
```

### AnacondaDockerベースから構築する
ポータビリティと再現性があるのでオススメ

```Dockerfile
FROM continuumio/anaconda3:latest
COPY . /app

# install base softwares
RUN apt update
RUN apt install build-essential mecab libmecab-dev mecab-ipadic -y
RUN pip install mecab-python3
RUN apt install git make sudo -y
RUN cd tmp; git clone --depth 1 https://github.com/neologd/mecab-ipadic-neologd.git; 
RUN cd /tmp/mecab-ipadic-neologd; ./bin/install-mecab-ipadic-neologd -n -y

# mecabrcはMeCabに必要
RUN echo "dicdir = /usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd" > /usr/local/etc/mecabrc

# python関連
RUN pip install -r ./app/requirements.txt
CMD python
```
